<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>profile2</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="../public/css/profile2.css" />
  </head>
  <body>
    <h1>프로필 수정</h1>
    <div class="content">
      <form name="editProfile" enctype="multipart/form-data">
        <div class="img">
          <div id="imagePreview">
            <img id="preview" src="" alt="미리보기" />
          </div>

          <input
            type="file"
            id="imageInput"
            accept="image/*"
            style="display: none"
            onchange="previewImage(this)"
          />

          <button
            type="button"
            onclick="document.getElementById('imageInput').click()"
          >
            이미지 선택
          </button>
        </div>
        <div class="name">
          <input type="text" id="name" placeholder="이름" value="" />
        </div>
        <div class="birth">
          <input type="date" id="birth" placeholder="생년월일" />
        </div>
        <div class="gender">
          <input type="radio" name="gender" id="man" vlaue="남자" /><label
            for="man"
            >남자</label
          >
          <input type="radio" name="gender" id="woman" vvalue="여자" /><label
            for="woman"
            >여자</label
          >
        </div>
        <div>
          <input type="text" id="phone_number" placeholder="전화번호" />
        </div>
        <div class="email">
          <input type="text" id="email" placeholder="이메일" />
        </div>

        <button type="button" id="editBtn" onclick="editProfileFunc()">
          수정하기
        </button>
      </form>
    </div>

    <script>
      let user;
      // get
      const token = sessionStorage.getItem("token");
      console.log("token", token);

      window.onload = function getUser() {
        axios({
          method: "GET",
          params: { token: token },
          url: "profile2/info",
        })
          .then((res) => {
            console.log("res");
            user = res.data.user;
            console.log("user", user);

            pushProfile();
          })
          .catch((err) => {
            console.error("Error", err);
          });
      };

      // 이미지 미리보기
      function previewImage(input) {
        const preview = document.getElementById("preview");
        const imagePreview = document.getElementById("imagePreview");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          console.log("이미지 미리보기 실행");

          reader.onload = function (e) {
            // 선택한 이미지를 미리보기로 표시합니다.
            preview.src = e.target.result;
            imagePreview.style.backgroundColor = "transparent"; // 빈 원의 배경색을 투명하게 설정합니다.
          };

          reader.readAsDataURL(input.files[0]);
        } else {
          // 이미지를 선택하지 않았을 때 빈 원을 원래대로 채웁니다.
          imagePreview.style.backgroundColor = "#ccc";
          preview.src = ""; // 이미지 미리보기 초기화
        }
      }
      // 업로드 이미지
      async function uploadImage() {
        const imageInput = document.getElementById("imageInput");
        const selectedImage = imageInput.files[0];
        console.log(selectedImage);
        if (selectedImage) {
          try {
            const formData = new FormData();
            formData.append("image", selectedImage);

            // 이미지를 업로드할 엔드포인트로 POST 요청 보내기
            const res = await axios.post("profile2/upload", formData, {
              headers: {
                "Content-Type": "multipart/form-data", // FormData를 사용할 때 필요한 헤더
              },
            });
            // console.log(res.data.file.location);
            const imgURL = res.data.file.location;
            console.log("uploadImage()함수 :", imgURL);
            return imgURL;

            alert("이미지 업로드가 완료되었습니다.");
          } catch (error) {
            console.error("이미지 업로드 중 오류 발생:", error);
          }
        } else {
          alert("이미지를 선택해주세요.");
        }
      }

      // -------- input 태그에 정보 넣기 -------------
      async function pushProfile() {
        // user 데이터가 존재하는지 확인
        if (user) {
          // 사용자 데이터에서 필요한 정보 추출
          const { name, birth, gender, phone_number, email } = user;

          // 각 input 요소에 사용자 데이터 설정
          document.getElementById("name").value = name || ""; // 이름
          document.getElementById("birth").value = birth || ""; // 생년월일
          // 성별 설정
          if (gender === "남자") {
            document.getElementById("man").checked = true;
          } else if (gender === "여자") {
            document.getElementById("woman").checked = true;
          }
          document.getElementById("phone_number").value = phone_number || ""; // 전화번호
          document.getElementById("email").value = email || ""; // 이메일
        }
      }

      async function editProfileFunc() {
        console.log("editProfileFunc");
        try {
          const form = document.forms["editProfile"];
          // const emailCheck = sessionStorage.getItem("emailCheck");
          const token = sessionStorage.getItem("token");
          const imgURL = await uploadImage();

          console.log(imgURL);

          console.log("editProfile");
          console.log(token);
          console.log(form.name.value);
          const res = axios({
            method: "POST",
            url: "/profile2/edit",
            data: {
              token,
              name: form.name.value,
              gender: form.gender.value,
              phone_number: form.phone_number.value,
              birth: form.birth.value,
              email: form.email.value,
              // location: document.getElementById("displayAddress").value,
              // image: document.getElementById("imageInput").files[0],
              imgURL,
            },
          });
        } catch (err) {
          console.log(err);
        }
      }
    </script>
  </body>
</html>
